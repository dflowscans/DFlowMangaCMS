@using MangaReader.Models
@{
    var user = ViewBag.User as User;
    var bookmarks = ViewBag.Bookmarks as List<UserBookmark>;
    var stats = ViewBag.ReadingStats;
    ViewData["Title"] = $"{user?.Username}'s Profile";
}

<div class="container py-4">
    <!-- Profile Header -->
    <div class="card mb-4" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 15px; overflow: hidden;">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-auto text-center mb-3 mb-md-0">
                    @{
                        var profileAvatarUrl = string.IsNullOrWhiteSpace(user?.AvatarUrl) 
                            ? $"https://ui-avatars.com/api/?name={user?.Username}&background=random&color=fff" 
                            : user.AvatarUrl;
                    }
                    <div class="position-relative d-inline-flex align-items-center justify-content-center" style="width:120px; height:120px;">
                        <img src="@profileAvatarUrl" alt="Avatar" style="width:100%; height:100%; border-radius:50%; object-fit:cover; border:3px solid var(--primary-color); z-index: 1; position: relative;" />
                        @if (user?.EquippedDecoration != null)
                        {
                            <img src="@user.EquippedDecoration.ImageUrl" alt="Decoration" style="position: absolute; top: 50%; left: 50%; width: 120%; height: 120%; transform: translate(-50%, -50%); pointer-events: none; z-index: 2;" />
                        }
                    </div>
                </div>
                <div class="col-md">
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                        <h2 class="mb-0 text-white" style="font-weight: 700;">@user?.Username</h2>
                        @if (user?.IsAdmin == true)
                        {
                            <span class="badge bg-danger">Admin</span>
                        }
                        else if (user?.IsSubAdmin == true)
                        {
                            <span class="badge bg-warning text-dark">Sub-Admin</span>
                        }
                    </div>

                    @if (user?.EquippedTitle != null)
                    {
                        <div class="mb-3">
                            <span class="badge" style="background: rgba(0,0,0,0.3); border: 1px solid @(user.EquippedTitle.Color ?? "transparent"); color: @(user.EquippedTitle.Color ?? "inherit"); font-weight: bold; font-size: 0.9rem; padding: 5px 12px;">
                                @user.EquippedTitle.Name
                            </span>
                        </div>
                    }

                    <div class="d-flex flex-wrap gap-4">
                        <div class="text-center">
                            <div class="text-white small text-uppercase">Level</div>
                            <div class="h5 mb-0 text-white">@user?.Level</div>
                        </div>
                        <div class="text-center">
                            <div class="text-white small text-uppercase">XP</div>
                            <div class="h5 mb-0 text-white">@user?.XP</div>
                        </div>
                        <div class="text-center">
                            <div class="text-white small text-uppercase">Comments</div>
                            <div class="h5 mb-0 text-white">@ViewBag.TotalComments</div>
                        </div>
                        <div class="text-center">
                            <div class="text-white small text-uppercase">Joined</div>
                            <div class="h5 mb-0 text-white">@user?.CreatedAt.ToString("MMM yyyy")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar: Reading Stats -->
        <div class="col-lg-4">
            @if (user?.HideReadingList != true)
            {
                <div class="card mb-4" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px;">
                    <div class="card-header" style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                        <h5 class="mb-0 text-white"><i class="fas fa-chart-pie me-2"></i>Reading Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-column gap-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-white"><i class="fas fa-book-open me-2 text-primary"></i>Reading</span>
                                <span class="badge bg-primary text-white rounded-pill">@stats.Reading</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-white"><i class="fas fa-check-circle me-2 text-success"></i>Completed</span>
                                <span class="badge bg-success text-white rounded-pill">@stats.Completed</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-white"><i class="fas fa-pause-circle me-2 text-warning"></i>On Hold</span>
                                <span class="badge bg-warning text-white rounded-pill">@stats.OnHold</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-white"><i class="fas fa-times-circle me-2 text-danger"></i>Dropped</span>
                                <span class="badge bg-danger text-white rounded-pill">@stats.Dropped</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-white"><i class="fas fa-bookmark me-2 text-info"></i>Plan to Read</span>
                                <span class="badge bg-info text-white rounded-pill">@stats.PlanToRead</span>
                            </div>
                            <hr style="border-color: var(--border-color); margin: 0.5rem 0;">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="text-white">Total Series</strong>
                                <strong class="text-white">@stats.Total</strong>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card mb-4" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px;">
                    <div class="card-body text-center py-4">
                        <i class="fas fa-user-shield fa-2x mb-3 text-primary"></i>
                        <h6 class="text-white">Private Profile</h6>
                        <p class="text-muted small mb-0">This user's reading activity is hidden.</p>
                    </div>
                </div>
            }
        </div>

        <!-- Main Content: Reading List -->
        <div class="col-lg-8">
            <div class="card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px;">
                <div class="card-header d-flex justify-content-between align-items-center" style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                    <h5 class="mb-0 text-white"><i class="fas fa-list me-2"></i>Reading List</h5>
                </div>
                <div class="card-body">
                    @if (user?.HideReadingList == true)
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-lock fa-3x mb-3 text-muted"></i>
                            <h5 class="text-muted">This user has hidden their reading list.</h5>
                        </div>
                    }
                    else if (bookmarks == null || !bookmarks.Any())
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-book fa-3x mb-3 text-muted"></i>
                            <h5 class="text-muted">No series in the reading list yet.</h5>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0" style="background: transparent;">
                                <thead>
                                    <tr style="border-bottom: 2px solid var(--border-color);">
                                        <th>Series</th>
                                        <th class="text-center">Status</th>
                                        <th class="text-end">Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var bookmark in bookmarks.OrderByDescending(b => b.UpdatedAt))
                                    {
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td class="align-middle">
                                                <a href="@Url.Action("Detail", "Series", new { id = bookmark.MangaId })" class="text-decoration-none d-flex align-items-center gap-3">
                                                    <img src="@bookmark.Manga?.ImageUrl" alt="@bookmark.Manga?.Title" style="width: 40px; height: 55px; object-fit: cover; border-radius: 4px;" />
                                                    <span class="text-white fw-bold">@bookmark.Manga?.Title</span>
                                                </a>
                                            </td>
                                            <td class="text-center align-middle">
                                                @{
                                                    var statusClass = bookmark.Status switch
                                                    {
                                                        BookmarkStatus.Reading => "bg-primary",
                                                        BookmarkStatus.Completed => "bg-success",
                                                        BookmarkStatus.OnHold => "bg-warning text-dark",
                                                        BookmarkStatus.Dropped => "bg-danger",
                                                        BookmarkStatus.PlanToRead => "bg-info",
                                                        _ => "bg-secondary"
                                                    };
                                                    var statusText = bookmark.Status.ToString().Replace("PlanToRead", "Plan to Read").Replace("OnHold", "On Hold");
                                                }
                                                <span class="badge @statusClass" style="font-size: 0.75rem;">@statusText</span>
                                            </td>
                                            <td class="text-end align-middle text-white small">
                                                @bookmark.UpdatedAt.ToString("MMM dd, yyyy")
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        transition: transform 0.2s ease;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.03) !important;
    }
    .badge {
        padding: 6px 10px;
        font-weight: 600;
    }
</style>